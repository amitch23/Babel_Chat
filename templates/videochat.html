<html>
<head>
    <link type="text/css" rel="stylesheet" href="/static/style.css"/>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>

    <link href="../static/css/custom.css" rel="stylesheet">

</head>
<body>

<p>
    name: {{ user.name }}<br/>
    email: {{ user.email }}<br/>
    native language: {{ user.language.language_name }}<br/>
    country: {{ user.country.country_name }}<br/>

    <strong><ul>Wants to learn</ul></strong>
   {% for lang in user.Language_desired %}
        <li>{{ lang.language.language_name }}</li>
   {% endfor %}<br/>


    {% if room_name %}
        {{ user.name }} is starting room: {{ room_name }}
    {% else %}
        {{ user.name }} is in the waiting room.
    {% endif %}

  </p>
<div id="video_wrapper">VIDEO GOES HERE</div>


<!-- 
 <form id="join" method='POST' action="#">
    <input type="text" name="join_room" id="join_room" placeholder="Room Name">
    <input type="submit" value="Join Room">
 </form> -->

<div id="game_wrapper">


<div id="game_forms"></div>
<div id="button_placeholder"></div>
<div id="game_content"></div>
 <!-- <form id="send_msg_to_clientA" method='POST' action='#'>
        <input type="text" name="emit_data" id="emit_data" placeholder="Message">
        <input type="submit" value="Send back to original sender"></div>
 </form> -->

  <form id="broadcast_to_all" method='POST' action='#'>
        <input type="text" name="broadcast_data" id="broadcast_data" placeholder="Message">
        <input type="submit" value="Broadcast to everyone (in any room)">
    </form>

    <form id="send_msg_to_room" method='POST' action='#'>
        <input type="text" name="room_name" id="room_name" placeholder="Room Name">
        <input type="text" name="room_data" id="room_data" placeholder="Message">
        <input type="submit" value="Send to Room">
    </form>

    <form id="leave" method='POST' action='#'>
        <input type="text" name="leave_room" id="leave_room" placeholder="Room Name">
        <input type="submit" value="Leave Room">
    </form>

<h2>Messages received:</h2>
<div id="log"></div>

</div> <!--game wrapper end div-->



<script type="text/javascript" charset="utf-8">
   
//handle connect sockets and join/leave room functionality

    var in_room = null;
    
    $(document).ready(function(){
        namespace = '/chat';

        var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

        //1.upon socket connection, emit the message "you're connected" to the client 
        socket.on('connect', function() {
            $('#log').append("<br>You're connected");
            //if initiating usr, join room in server and invite others to join
            {% if room_name %}
                //populate input box with room name if in room
                in_room = "{{ room_name }}";
                console.log("{{room_name}}");
                $("#room_name").val(in_room);
                //upon connect of initiating, join room
                socket.emit('join', {start: 1, room: "{{ room_name }}" });
            {% endif %}
            });


        // 'message' passes data to this function, which appends message to div element id = log
        socket.on('output to log', function(msg) {
            console.log(msg);
            console.log(msg["count"]);
            $('#log').append('<br>Received #' + msg.count + ': ' + msg.data);
        });



        //5. put a button on the page for jose when 1st client starts room to join the room and pass the room name and maybe his name?)
        socket.on('invite_to_join', function(msg) {
            //magically put button that will offer a join room button,
            //then in another js listener function, call the join function, which will finally add the 2nd user to the room. Now both will have sockets to the server, will be in the same room, and the data objects passed will....dunno
            console.log(msg);
            console.log(msg.count);

            {% if room_name==None %}
                var btn = $('<button />')
                    .text("Click to join " + msg.room_name)
                    .click(function(event)
                    {
                        socket.emit('join', {start: 2, room: msg.room_name});
                        $("#room_name").val(msg.room_name);
                    });
                   $('#button_placeholder').append(btn); 

            {% endif %}

            //append received message to log div
            $('#log').append('<br>Received #' + msg.count + ': ' + msg.data);

        });


        //make invite button disappear and pass room name and start value(?) to server to query for what game to start with first.
        socket.on("start_game", function(msg) {
            console.log("game started");
            $('#button_placeholder').empty(); 
            socket.emit('get_game_content', {room: msg.room_name, start: 2});

        });



        //display contents one by one to both clients
        socket.on("display_game_content", function(msg) {

           //

            var counter = 0

            $('#game_content').append(msg.game_content[0]);

            var btn = $('<button />')
                .text("Next")
                .click(function(event)
                {
                    if (counter > msg.game_content.length) {
                        console.log("end game");
                    }
                    else {
                    counter = counter + 1;
                    $('#game_content').html(msg.game_content[counter]);
                    }
                });
            $('#button_placeholder').append(btn); 


        });

 



          //on submit button, emit object to client @ 'my room event' in babel.py, which then sends data to 'my response' handler above
        $('form#send_msg_to_room').submit(function(event) {
            socket.emit('my room event', {room: $('#room_name').val(), data: $('#room_data').val()});
            return false;
        });

        $('form#leave').submit(function(event) {
            socket.emit("leave", {room: $("#leave_room").val()});
            return false;

        });

//handle connect sockets and join/leave room functionality

        
      






        // //handler for joining room
        // $('form#join').submit(function(event) {
        //     socket.emit('join', {room: $('#join_room').val()});
        //     return false;
        // });


        //handler to send input data to 'message' in server
        //  $('form#send_msg_to_clientA').submit(function(event) {
        //     socket.emit('message', {data: $('#emit_data').val()});
        //     return false;
        // });


        //handler to broadcast data to all clients
        // $('form#broadcast_to_all').submit(function(event) {
        //     socket.emit('my broadcast event', {data: $('#broadcast_data').val()});
        //     return false;
        // });
        


    });

  


</script>




 </body>
 </html>